{% extends 'base.html' %}
{% block title %}Salary{% endblock %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="mx-auto max-w-3xl p-6 bg-white rounded-lg shadow-lg">
  <h3 class="text-2xl font-semibold mb-6">Salary Breakdown</h3>

  <form method="post" id="salary-form" class="space-y-6">
    <div>
      <label for="gross_salary" class="block font-medium mb-2">Gross Salary</label>
      <input type="number" step="0.01" name="gross_salary" id="gross_salary" value="{{ salary.gross_salary }}" required class="w-full px-3 py-2 border rounded-md" />
    </div>

    <div>
      <label class="block font-medium mb-2">Deductions</label>
      <div id="deductions-list" class="space-y-4">
        {% for k, v in salary.deductions.items() if k != 'Other' %}
          <div class="flex items-center space-x-3">
            <input type="text" readonly value="{{ k }}" class="flex-1 px-3 py-2 border rounded-md bg-gray-100" />
            <input type="number" step="0.0001" min="0" max="1" name="deductions[{{ k }}]" value="{{ v }}" class="w-24 px-3 py-2 border rounded-md" />
            <button type="button" onclick="removeDeduction(this)" class="text-red-500 hover:text-red-700">Remove</button>
            <button type="button" title="Info about {{ k }}" onclick="window.open('https://en.wikipedia.org/wiki/{{ k|replace(' ','_') }}','_blank')" class="text-blue-500 hover:text-blue-700">&#9432;</button>
          </div>
        {% else %}
          {% for k, v in defaults.items() if k != 'Other' %}
            <div class="flex items-center space-x-3">
              <input type="text" readonly value="{{ k }}" class="flex-1 px-3 py-2 border rounded-md bg-gray-100" />
              <input type="number" step="0.0001" min="0" max="1" name="deductions[{{ k }}]" value="{{ v }}" class="w-24 px-3 py-2 border rounded-md" />
              <button type="button" onclick="removeDeduction(this)" class="text-red-500 hover:text-red-700">Remove</button>
              <button type="button" title="Info about {{ k }}" onclick="window.open('https://en.wikipedia.org/wiki/{{ k|replace(' ','_') }}','_blank')" class="text-blue-500 hover:text-blue-700">&#9432;</button>
            </div>
          {% endfor %}
        {% endfor %}
      </div>

      <button type="button" id="add-deduction-btn" class="mt-3 inline-flex items-center px-3 py-1.5 bg-green-500 text-white rounded hover:bg-green-600">
        + Add Deduction
      </button>
    </div>

    <div class="mt-6">
      <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Salary</button>
    </div>
  </form>

  <div class="mt-8">
    <h4 class="text-xl font-semibold mb-3">Net Salary: <span id="net-salary" class="text-green-600">{{ salary.net_salary | round(2) }}</span></h4>
  </div>

  <canvas id="deductionsChart" class="mt-6"></canvas>
</div>

<script>
  // Dynamically add/remove deduction rows
  document.getElementById('add-deduction-btn').addEventListener('click', () => {
    const container = document.getElementById('deductions-list');

    const div = document.createElement('div');
    div.className = 'flex items-center space-x-3';
    div.innerHTML = `
      <input type="text" name="deduction_name[]" placeholder="Deduction Name" class="flex-1 px-3 py-2 border rounded-md" required/>
      <input type="number" step="0.0001" min="0" max="1" name="deduction_rate[]" placeholder="Rate (e.g. 0.1)" class="w-24 px-3 py-2 border rounded-md" required/>
      <button type="button" onclick="removeDeduction(this)" class="text-red-500 hover:text-red-700">Remove</button>
    `;
    container.appendChild(div);
  });

  function removeDeduction(btn) {
    btn.parentNode.remove();
  }

  // Chart.js Doughnut chart for visualizing deductions
  const ctx = document.getElementById('deductionsChart').getContext('2d');

  // Prepare labels and data from existing deductions
  const labels = [];
  const data = [];
  {% for k,v in salary.deductions.items() %}
    labels.push("{{ k }}");
    data.push({{ (salary.gross_salary * v) | round(2) }});
  {% endfor %}

  const deductionsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        label: 'Deductions',
        data: data,
        backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#6366f1','#8b5cf6','#f43f5e'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
      }
    }
  });
</script>
{% endblock %}
